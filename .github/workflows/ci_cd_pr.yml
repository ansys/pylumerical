name: pull-request
on:
  pull_request:
    types: [opened, reopened, synchronize, edited, labeled, closed]

env:
  MAIN_PYTHON_VERSION: '3.13'
  LIBRARY_NAME: 'ansys-lumerical-core' # Note that this is duplicated in the build-test-package job
  DOCUMENTATION_CNAME: 'lumerical.docs.pyansys.com' # Note that this is duplicated in the build-test-package job

# Disable all default permissions at workflow level for security (least privilege principle)
# Individual jobs will explicitly request only the permissions they need
permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  actions-security:
    name: "Actions Security"
    runs-on: ubuntu-latest
    steps:
      - uses: ansys/actions/check-actions-security@v10
        with:
          generate-summary: true
          token: ${{ secrets.GITHUB_TOKEN }}
          auditing-level: "high"
          trust-ansys-actions: true

  vulnerabilities:
    name: Vulnerabilities
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: PyAnsys Vulnerability check (on PR)
        uses: ansys/actions/check-vulnerabilities@v10
        with:
          python-version: ${{ env.MAIN_PYTHON_VERSION }}
          python-package-name: ${{ env.LIBRARY_NAME }}
          token: ${{ secrets.PYANSYS_CI_BOT_TOKEN }}
          dev-mode: ${{ github.ref != 'refs/heads/main' }}
          upload-reports: true

  update-changelog:
    name: "Update CHANGELOG (on release)"
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags')
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to push changelog updates
      pull-requests: write # Required to update PRs
    steps:
      - uses: ansys/actions/doc-deploy-changelog@v10
        with:
          bot-user: ${{ secrets.PYANSYS_CI_BOT_USERNAME }}
          bot-email: ${{ secrets.PYANSYS_CI_BOT_EMAIL }}
          token: ${{ secrets.PYANSYS_CI_BOT_TOKEN }}

  labeler:
    name: "Labels"
    permissions:
      contents: read # Required to read repository contents
      pull-requests: write # Required to write labels
    runs-on: ubuntu-latest
    steps:
     - name: "Checkout project"
       uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
       with:
        persist-credentials: false
     - name: "Sync labels"
       uses: micnncim/action-label-syncer@3abd5ab72fda571e69fffd97bd4e0033dd5f495c # v1.3.0
       env:
         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
     - name: "Label pull-request"
       # HACK: skip if contributor does not have write permissions (forks)
       if: github.event.pull_request.head.repo.full_name == github.repository
       uses: actions/labeler@634933edcd8ababfe52f92936142cc22ac488b1b # v6.0.1
       with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}

  changelog-fragment:
    name: "Create changelog fragment"
    needs: labeler
    permissions:
      contents: write # Required to push changelog updates
      pull-requests: write # Required to update PRs
    runs-on: ubuntu-latest
    steps:
    - uses: ansys/actions/doc-changelog@v10
      with:
        token: ${{ secrets.PYANSYS_CI_BOT_TOKEN }}
        use-conventional-commits: true
        use-default-towncrier-config: true
        bot-user: ${{ secrets.PYANSYS_CI_BOT_USERNAME }}
        bot-email: ${{ secrets.PYANSYS_CI_BOT_EMAIL }}

  commit-style:
    name: "Run commit style checks"
    runs-on: ubuntu-latest
    steps:
      - uses: ansys/actions/check-pr-title@v10
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  build-test-package:
    name: "Build, Test, and Package"
    needs: changelog-fragment
    permissions:
      id-token: write # Required for trusted publisher
      contents: write # Required for GitHub uploads and reusable workflow
      attestations: write # Required to create attestations
    uses: ./.github/workflows/common-build-test-package.yml
    with:
      library-name: 'ansys-lumerical-core'
      documentation-cname: 'lumerical.docs.pyansys.com'
      skip-doc-build-if-closed: ${{ github.event.action == 'closed' }}
    secrets:
      PYANSYS_CI_BOT_TOKEN: ${{ secrets.PYANSYS_CI_BOT_TOKEN }}
      LICENSE_SERVER: ${{ secrets.LICENSE_SERVER }}
      TOKEN: ${{ secrets.GITHUB_TOKEN }}

  doc-deploy-pr:
    name: "Deploy PR documentation"
    runs-on: ubuntu-latest
    needs: build-test-package
    if: always() && (needs.build-test-package.result == 'success' || needs.build-test-package.result == 'skipped')
    permissions:
      contents: write # Required to deploy PR documentation
      pull-requests: write # Needed to add comments to the PR when cleaning pull directory
    steps:
      - uses: ansys/actions/doc-deploy-pr@v10
        with:
          cname: ${{ env.DOCUMENTATION_CNAME }}
          token: ${{ secrets.PYANSYS_CI_BOT_TOKEN }}
          bot-user: ${{ secrets.PYANSYS_CI_BOT_USERNAME }}
          bot-email: ${{ secrets.PYANSYS_CI_BOT_EMAIL }}
          maximum-pr-doc-deployments: 10

